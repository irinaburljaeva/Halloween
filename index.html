<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Haunted Escape Room ‚Äî Halloween (B1)</title>
<style>
  :root{
    --bg:#0f0f14; --card:#181922; --ink:#e8ecff; --muted:#aeb3d1;
    --accent:#ff7a00; --ok:#3ecf8e; --warn:#ffcc00; --bad:#ff5a6a;
    --shadow:0 10px 30px rgba(0,0,0,.4);
  }
  html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 70% -10%,#1b1c28 0%, #0f0f14 55%);}
  body{color:var(--ink);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
  .wrap{max-width:980px;margin:0 auto;padding:22px 14px 40px;}
  h1{font-size:clamp(24px,3.8vw,36px);margin:6px 0 10px;letter-spacing:.5px}
  .sub{color:var(--muted);margin-bottom:18px}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 18px}
  .btn{background:var(--card);color:var(--ink);border:1px solid #2b2d3a;border-radius:10px;padding:10px 14px;cursor:pointer;box-shadow:var(--shadow);transition:transform .05s}
  .btn:active{transform:translateY(1px)}
  .btn.ok{background:#183826;border-color:#265b3e;color:#c9f7df}
  .btn.ghost{background:transparent;border:1px dashed #3b3d4f;color:var(--muted)}
  .row{display:grid;grid-template-columns:1fr;gap:16px}
  @media(min-width:880px){.row{grid-template-columns:1fr 1fr}}
  .card{background:linear-gradient(180deg,#1a1c29 0%,#141521 100%);border:1px solid #2a2c3a;border-radius:16px;box-shadow:var(--shadow);padding:16px}
  .title{font-weight:700;margin:0 0 10px;display:flex;align-items:center;gap:10px}
  .hint{color:var(--warn);font-size:14px;margin-top:8px}
  .okMsg{color:var(--ok);font-weight:600}
  .badMsg{color:var(--bad);font-weight:600}
  .muted{color:var(--muted)}
  .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .center{display:grid;place-items:center}
  .input, .code{background:#0f1017;border:1px solid #2b2d3a;color:var(--ink);padding:10px 12px;border-radius:10px}
  .code{font-weight:700;letter-spacing:2px;width:110px;text-align:center}
  .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#0d0e14;border:1px solid #2a2b38;color:var(--muted);font-size:12px}
  .kbrd{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;background:#10121a;border:1px solid #2f3040;padding:2px 6px;border-radius:6px}
  .progress{height:10px;background:#0d0e14;border:1px solid #2a2b38;border-radius:999px;overflow:hidden;margin:8px 0 0}
  .bar{height:100%;width:0;background:linear-gradient(90deg,#ff7a00,#ffb703);transition:width .4s}
  .drags{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
  .chip{user-select:none;padding:8px 10px;border-radius:12px;border:1px solid #3a3c51;background:#121320;cursor:grab}
  .chip.dragging{opacity:.6}
  .drop{min-height:66px;background:#0e1017;border:2px dashed #3a3c51;border-radius:12px;padding:8px}
  .drop.filled{border-style:solid;border-color:#2d885f;background:#0f1a16}
  .letters{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:6px}
  .tile{background:#10121a;border:1px solid #2e3043;border-radius:10px;padding:10px 12px;min-width:40px;text-align:center;font-weight:700;cursor:grab}
  .slots{display:flex;gap:8px;justify-content:center;margin-top:10px}
  .slot{width:40px;height:44px;border-radius:10px;border:2px dashed #3a3c51;background:#0f1017;display:grid;place-items:center;font-weight:700}
  .slot.filled{border-color:#2d885f;background:#0f1a16}
  .foot{color:var(--muted);font-size:12px;margin-top:18px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Haunted Escape Room</h1>
  <div class="sub">B1 interactive lesson ‚Ä¢ Solve the clues and open the final door.</div>

  <div class="toolbar">
    <button class="btn ghost" id="btnHint">Hint</button>
    <button class="btn ghost" id="btnReset">Reset</button>
    <label class="pill"><input type="checkbox" id="reveal" /> Teacher reveal</label>
  </div>

  <div class="card">
    <p class="muted"><strong>Story:</strong> You wake up in a dusty house. A cold note whispers: ‚ÄúFour rooms. Four steps. Then you‚Äôre free.‚Äù</p>
    <div class="progress"><div class="bar" id="bar" style="width:0%"></div></div>
  </div>

  <!-- ROOM 1 -->
  <div class="row" id="room1">
    <div class="card">
      <h3 class="title">Room 1 ‚Äî The Library üîí</h3>
      <p>Read the note carefully and find a <strong>4-digit code</strong> for the keypad.</p>
      <p class="muted" id="libText">
        The calendar shows <em>31 October</em>. Two thin candles are still burning on the table.
        A big grandfather clock is frozen at <strong>seven o‚Äôclock</strong>. On the wall, a painting shows
        <strong>three ravens</strong> flying above the trees. The note says:
        <q>Take the <u>second number of the date</u>, then the <u>candles</u>, then the <u>hour</u>, then the <u>ravens</u>.</q>
      </p>
      <div class="flex">
        <input class="code" id="code1" maxlength="4" placeholder="____" />
        <button class="btn" id="check1">Unlock</button>
        <span id="msg1"></span>
      </div>
      <div class="foot">Answer key (for teacher): <span class="kbrd">1273</span></div>
    </div>
    <div class="card center">
      <div>
        <p class="muted">Vocabulary focus:</p>
        <ul class="muted">
          <li><b>frozen at</b> ‚Äî stopped at (time)</li>
          <li><b>ravens</b> ‚Äî big black birds</li>
          <li><b>in this order</b> ‚Äî first A, then B, etc.</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- ROOM 2 -->
  <div class="row" id="room2" style="display:none">
    <div class="card">
      <h3 class="title">Room 2 ‚Äî The Potion Lab üß™</h3>
      <p>Drag the <strong>3 correct ingredients</strong> into the cauldron to brew a light potion.</p>
      <ul class="muted">
        <li>It must come from the <b>night sky</b> (not a liquid).</li>
        <li>Add an <b>autumn symbol</b> from the garden.</li>
        <li>Finish with something that can <b>fly</b> but is <b>not a bat</b> and is <b>blue</b>.</li>
      </ul>
      <div class="drags" id="ingredients">
        <div class="chip" draggable="true" data-id="moon">silver moon dust</div>
        <div class="chip" draggable="true" data-id="slime">green slime bottle</div>
        <div class="chip" draggable="true" data-id="legs">two spider legs</div>
        <div class="chip" draggable="true" data-id="pumpkin">pumpkin slice</div>
        <div class="chip" draggable="true" data-id="salt">a handful of salt</div>
        <div class="chip" draggable="true" data-id="feather">blue feather</div>
      </div>
      <div class="drop" id="cauldron" aria-label="Cauldron ‚Äî drop 3 items here"></div>
      <div class="flex" style="margin-top:8px">
        <button class="btn" id="check2">Brew</button>
        <button class="btn ghost" id="reset2">Clear</button>
        <span id="msg2"></span>
      </div>
      <div class="foot">Answer key: <span class="kbrd">moon dust</span>, <span class="kbrd">pumpkin slice</span>, <span class="kbrd">blue feather</span></div>
    </div>
    <div class="card">
      <p class="muted"><b>Language aim:</b> describing items and reasons ‚Äî ‚ÄúI chose the feather because it can fly.‚Äù</p>
      <p class="muted">Optional speaking: Ask the student to explain each choice in one sentence.</p>
    </div>
  </div>

  <!-- ROOM 3 -->
  <div class="row" id="room3" style="display:none">
    <div class="card">
      <h3 class="title">Room 3 ‚Äî The Gallery üñºÔ∏è</h3>
      <p>Build the secret word by dragging letters into the boxes.</p>
      <div class="letters" id="letters"></div>
      <div class="slots" id="slots"></div>
      <div class="flex" style="margin-top:10px">
        <button class="btn" id="check3">Check word</button>
        <button class="btn ghost" id="reset3">Shuffle</button>
        <span id="msg3"></span>
      </div>
      <div class="foot">Answer key: <span class="kbrd">PUMPKIN</span></div>
    </div>
    <div class="card">
      <p class="muted"><b>Tip:</b> say the letters aloud while moving them to reinforce spelling.</p>
    </div>
  </div>

  <!-- ROOM 4 -->
  <div class="row" id="room4" style="display:none">
    <div class="card">
      <h3 class="title">Final Door üö™</h3>
      <p>Enter the <b>library code</b> again and the <b>gallery word</b>. If your potion was correct, the door will open.</p>
      <div class="flex">
        <input class="code" id="finalCode" maxlength="4" placeholder="code" />
        <input class="input" id="finalWord" maxlength="16" placeholder="word (UPPERCASE or lowercase)" />
        <button class="btn ok" id="finish">Open</button>
      </div>
      <p id="finalMsg" style="margin-top:8px"></p>
    </div>
    <div class="card center">
      <div class="muted">Great for B1 speaking: ‚ÄúWhat was the hardest clue? Why?‚Äù</div>
    </div>
  </div>

  <div id="hintBox" class="card" style="display:none;margin-top:14px"></div>

  <p class="foot">¬© For classroom use. Works offline. No external assets.</p>
</div>

<script>
/* ---------- UTILS ---------- */
const $ = s => document.querySelector(s);
const $$ = s => [...document.querySelectorAll(s)];
const state = {
  r1:false, r2:false, r3:false,
  code1:'1273',
  potionSet: new Set(['moon','pumpkin','feather']),
  galleryWord:'PUMPKIN'
};
function progress(){
  const done = [state.r1,state.r2,state.r3].filter(Boolean).length;
  $('#bar').style.width = (done/3*100)+'%';
}
function show(id){ $(id).style.display = ''; }
function hide(id){ $(id).style.display = 'none'; }
function say(el,msg,type=''){ el.innerHTML = `<span class="${type==='ok'?'okMsg':type==='bad'?'badMsg':'muted'}">${msg}</span>`; }

/* ---------- TEACHER REVEAL ---------- */
$('#reveal').addEventListener('change', e=>{
  $$('.foot').forEach(f=> f.style.display = e.target.checked ? '' : 'none');
});
$('#reveal').checked = false; $$('.foot').forEach(f=> f.style.display='none');

/* ---------- HINTS ---------- */
const hint = $('#hintBox');
const hints = {
  1: `Library hint: <br>Take these numbers <b>in order</b> ‚Äî date‚Äôs second digit, number of candles, the hour on the clock, number of ravens.`,
  2: `Potion hint: <br>Night sky (solid, not liquid) ‚Üí <b>moon dust</b>. Autumn symbol ‚Üí <b>pumpkin</b>. Can fly and blue ‚Üí <b>feather</b>.`,
  3: `Gallery hint: <br>It‚Äôs a classic Halloween word. Starts with <b>P</b> and ends with <b>N</b>.`
};
let currentRoom = 1;
$('#btnHint').addEventListener('click', ()=>{
  hint.style.display = '';
  hint.innerHTML = hints[currentRoom];
});

/* ---------- RESET ---------- */
$('#btnReset').addEventListener('click', ()=>location.reload());

/* ---------- ROOM 1 ---------- */
$('#check1').addEventListener('click', ()=>{
  const v = ($('#code1').value || '').replace(/\D/g,'');
  if(v === state.code1){
    say($('#msg1'),'The lock clicks open. Go to the next room!','ok');
    state.r1 = true; progress(); next(2);
  }else{
    say($('#msg1'),'Not yet. Read the note again.','bad');
  }
});
function next(n){
  currentRoom = n;
  ['#room1','#room2','#room3','#room4'].forEach((id,i)=> i+1===n ? show(id) : hide(id));
}

/* ---------- ROOM 2 (drag & drop) ---------- */
const cauldron = $('#cauldron');
let chosen = [];
function setupDrag(){
  $$('#ingredients .chip').forEach(chip=>{
    chip.addEventListener('dragstart', e=>{
      e.dataTransfer.setData('text/plain', chip.dataset.id);
      chip.classList.add('dragging');
    });
    chip.addEventListener('dragend', ()=> chip.classList.remove('dragging'));
  });
  ['dragover','dragenter'].forEach(ev=> cauldron.addEventListener(ev, e=>{
    e.preventDefault();
  }));
  cauldron.addEventListener('drop', e=>{
    e.preventDefault();
    const id = e.dataTransfer.getData('text/plain');
    if(!id) return;
    if(chosen.includes(id)) return;
    if(chosen.length>=3) return;
    chosen.push(id);
    const clone = document.querySelector(`.chip[data-id="${id}"]`).cloneNode(true);
    clone.removeAttribute('draggable');
    clone.classList.remove('dragging');
    cauldron.appendChild(clone);
    cauldron.classList.toggle('filled', chosen.length>0);
  });
}
setupDrag();

$('#reset2').addEventListener('click', ()=>{
  chosen = [];
  cauldron.innerHTML = '';
  cauldron.classList.remove('filled');
  say($('#msg2'),'','');
});

$('#check2').addEventListener('click', ()=>{
  const ok = chosen.length===3 && chosen.every(x=>state.potionSet.has(x));
  if(ok){
    say($('#msg2'),'The potion glows softly. You feel safer.','ok');
    state.r2 = true; progress(); next(3);
  }else{
    say($('#msg2'),'The cauldron spits. Try a different combination.','bad');
  }
});

/* ---------- ROOM 3 (letters) ---------- */
const letters = 'PUMPKIN'.split('');
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a;}
function buildLetters(){
  $('#letters').innerHTML = '';
  $('#slots').innerHTML = '';
  // tiles
  shuffle([...letters]).forEach((ch,idx)=>{
    const t = document.createElement('div');
    t.className='tile'; t.textContent=ch; t.draggable=true; t.dataset.letter=ch;
    t.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', ch); t.classList.add('dragging');});
    t.addEventListener('dragend', ()=> t.classList.remove('dragging'));
    $('#letters').appendChild(t);
  });
  // slots
  letters.forEach((_,i)=>{
    const s = document.createElement('div');
    s.className='slot'; s.dataset.index=i;
    s.addEventListener('dragover', e=>e.preventDefault());
    s.addEventListener('drop', e=>{
      e.preventDefault();
      const ch = e.dataTransfer.getData('text/plain');
      if(!ch || s.textContent) return;
      s.textContent = ch; s.classList.add('filled'); s.dataset.letter=ch;
    });
    s.addEventListener('dblclick', ()=>{ s.textContent=''; s.classList.remove('filled'); delete s.dataset.letter; });
    $('#slots').appendChild(s);
  });
}
buildLetters();

$('#reset3').addEventListener('click', buildLetters);

$('#check3').addEventListener('click', ()=>{
  const word = $$('#slots .slot').map(s=>s.dataset.letter||'').join('');
  if(word.toUpperCase() === state.galleryWord){
    say($('#msg3'),'The portraits blink. A secret key appears.','ok');
    state.r3 = true; progress(); next(4);
  }else{
    say($('#msg3'),'Look again. The word is connected with Halloween.','bad');
  }
});

/* ---------- FINAL DOOR ---------- */
$('#finish').addEventListener('click', ()=>{
  const c = ($('#finalCode').value||'').replace(/\D/g,'');
  const w = ($('#finalWord').value||'').trim().toUpperCase();
  const potionOk = state.r2; // must be brewed correctly
  if(c===state.code1 && w===state.galleryWord && potionOk){
    $('#finalMsg').innerHTML = `<span class="okMsg">The door opens. You escaped! üß°</span>`;
  }else{
    $('#finalMsg').innerHTML = `<span class="badMsg">Something is wrong. Check the library code, the potion, and the word.</span>`;
  }
});

/* start at room 1 */
next(1);
</script>
</body>
</html>
